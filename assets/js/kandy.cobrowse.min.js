KandyAPI.CoBrowse=function(){var q={},l=!1,y=!1,n=!0,A=!0,B,r=-1,h="",t="",D="",f,u,v,p,e,g,Q=function(a){if(!1!==l)switch(a.payload.type){case "screenUpdate":P(a.payload.data);break;case "userMousePosition":a=a.payload.data;if("undefined"!=typeof v){if(null==document.getElementById("coBrowsingCursor-"+f)){var c=document.createElement("img");c.id="coBrowsingCursor-"+f;c.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAMAAAAbzM5ZAAABNVBMVEUAvuf///8AvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucBveYCuuECuuIDuN8Ett0FtdsGstcHsNUIr9MJrdEKqs0Kq80Kq84LqMoMpsgPocEQnr0RnbwSm7kWkq0XkasYj6kaiqIdhJoeg5kgf5MhfJAkdogkd4kldYcmcoMqa3oraXYsaHQwYGoxXmc0WGA1VVw1Vl06TFA7Sk07Sk48R0o8SEo+Q0Q+REU/QUE/QkNAQEBAQEFG5UD4AAAANHRSTlMAAAIEBggKHCMnKS0uNTk7PEBCSUpLU1dcX2tsbnFzdXeAhYuSk5aho63Fz9XZ29/l6uv9gq4ZTAAAAQBJREFUeAFdzmcjQmEAR/EngwzZkSSyR0aOvUe2DMoW8u/7fwRuV7r3OS9/r44xJhhpMG6Bv4wZBhbCfgwCQNSHETjbBRJeHILMRxqYsFCfJ8BUsx9VvASSLX6Urpcg1WahsstAl4V6WAN6LdTzFhC1UK8HQMJCucMWusOtFpaGBy0s5NLQ7sO3zAZAtReLe1Ca+sfHgpSB2YG68tLX3T456X0FGp35OFzcbgPHkk5hxMEQ5V6kJ1is+kUzDjA/BueSDqHPQROKj/aYJljNS/cwV0K3abiRvjehvoJh2CkqfwQdFTQpyF6tAzUejOHWH/BgbRJgptv59GhsMtEZcPoBmRFquUFm5kkAAAAASUVORK5CYII=";
c.style.position="absolute";c.style.zIndex="2147483647";v.appendChild(c)}jQuery(document.getElementById("coBrowsingCursor-"+f)).animate({left:a.x,top:a.y},10)}break;case "userWindowScroll":a=a.payload.data;"undefined"!=typeof v&&(n=!1,e.scroll(a.x,a.y));break;case "userWindowResize":a=a.payload.data;jQuery(p).animate({width:a.x,height:a.y});break;case "closeCoBrowse":q.stopBrowsingAgent()}},R=function(a){if(!1!==l)switch(a.payload.type){case "agentWindowScroll":a=a.payload.data;n=!1;window.scroll(a.x,
a.y);break;case "agentMouseMove":a=a.payload.data;if(null==document.getElementById("coBrowsingCursor-"+f)){var c=document.createElement("img");c.id="coBrowsingCursor-"+f;c.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAMAAAAbzM5ZAAABNVBMVEUAvuf///8AvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucAvucBveYCuuECuuIDuN8Ett0FtdsGstcHsNUIr9MJrdEKqs0Kq80Kq84LqMoMpsgPocEQnr0RnbwSm7kWkq0XkasYj6kaiqIdhJoeg5kgf5MhfJAkdogkd4kldYcmcoMqa3oraXYsaHQwYGoxXmc0WGA1VVw1Vl06TFA7Sk07Sk48R0o8SEo+Q0Q+REU/QUE/QkNAQEBAQEFG5UD4AAAANHRSTlMAAAIEBggKHCMnKS0uNTk7PEBCSUpLU1dcX2tsbnFzdXeAhYuSk5aho63Fz9XZ29/l6uv9gq4ZTAAAAQBJREFUeAFdzmcjQmEAR/EngwzZkSSyR0aOvUe2DMoW8u/7fwRuV7r3OS9/r44xJhhpMG6Bv4wZBhbCfgwCQNSHETjbBRJeHILMRxqYsFCfJ8BUsx9VvASSLX6Urpcg1WahsstAl4V6WAN6LdTzFhC1UK8HQMJCucMWusOtFpaGBy0s5NLQ7sO3zAZAtReLe1Ca+sfHgpSB2YG68tLX3T456X0FGp35OFzcbgPHkk5hxMEQ5V6kJ1is+kUzDjA/BueSDqHPQROKj/aYJljNS/cwV0K3abiRvjehvoJh2CkqfwQdFTQpyF6tAzUejOHWH/BgbRJgptv59GhsMtEZcPoBmRFquUFm5kkAAAAASUVORK5CYII=";
c.style.position="fixed";c.style.zIndex="2147483647";document.body.appendChild(c)}jQuery(document.getElementById("coBrowsingCursor-"+f)).animate({left:a.x,top:a.y},10);break;case "agentClick":document.getElementById(a.payload.data).click();break;case "agentInputChange":a=a.payload.data;c=document.getElementById(a.id);A=!1;switch(a.type){case "INPUT":c.value=a.value;break;case "SELECT":for(var b=c.options.length-1;0<=b;b--)c.options[b].selected=a.options[b];break;case "TEXTAREA":c.value=a.value}break;
case "requestFullPage":z("HTML",a.full_user_id)}},k=function(a,c,b){!1!==l&&KandyAPI.Session.sendData(f,{type:a,data:c},null,null,b)},P=function(a){if("undefined"===typeof p||null==p)u.innerHTML='<div id="coBrowsingDiv-'+f+'" style="position: relative;"></div>',v=document.getElementById("coBrowsingDiv-"+f),v.innerHTML='<iframe id="coBrowsingIframe-'+f+'" sandbox="allow-same-origin allow-scripts" src="javascript:;" style="border: none;"></iframe>',p=document.getElementById("coBrowsingIframe-"+f),e=
p.contentWindow,g=e.document;var c=w(a.html);if(("HTML"==a.element||"HEAD"==a.element)&&"string"==typeof a.baseURI&&!c.head.getElementsByTagName("base")[0]){var b=document.createElement("base");b.href=a.baseURI;c.head.firstChild?c.head.insertBefore(b,c.head.firstChild):c.head.appendChild(b)}if("HTML"==a.element)jQuery(p).animate({width:a.screenx,height:a.screeny}),y=!0,c=C(c),g.open(),g.write(c),g.close(),"complete"===g.readyState?(y=!1,e.scroll(a.scrollx,a.scrolly)):g.onreadystatechange=function(){"complete"===
g.readyState&&(y=n=!1,e.scroll(a.scrollx,a.scrolly))},E(),e.addEventListener("mousemove",F),e.addEventListener("scroll",G),e.addEventListener("click",H),e.addEventListener("input",I);else if("HEAD"==a.element)g.documentElement.replaceChild(c.head.cloneNode(!0),g.head);else if("BODY"==a.element)g.documentElement.replaceChild(c.body.cloneNode(!0),g.body);else{var b=a.element.substr(1),d=g.getElementById(b);d.parentNode.replaceChild(c.getElementById(b).cloneNode(!0),d)}if("string"==typeof a.css){c=g.getElementsByTagName("style");
for(b=0;b<c.length;b++)c[b].parentNode.removeChild(c[b]);c=document.createElement("style");c.type="text/css";c.appendChild(document.createTextNode(a.css));g.head.appendChild(c)}e.focus();console.log(Math.floor(Date.now()/1E3)+" Changed "+a.element)},E=function(){"undefined"!=typeof e&&(e.removeEventListener("mousemove",F),e.removeEventListener("scroll",G),e.removeEventListener("click",H),e.removeEventListener("input",I))},H=function(a){a.preventDefault();null!=a.target.id&&""!=a.target.id&&k("agentClick",
a.target.id)},F=function(a){k("agentMouseMove",{x:a.clientX,y:a.clientY})},G=function(a){n&&!y&&k("agentWindowScroll",{x:0!=a.target.documentElement.scrollLeft?a.target.documentElement.scrollLeft:a.target.body.scrollLeft,y:0!=a.target.documentElement.scrollTop?a.target.documentElement.scrollTop:a.target.body.scrollTop});n=!0},I=function(a){a=a.target;var c={id:a.id,type:a.nodeName};switch(a.nodeName){case "INPUT":switch(a.type){case "password":for(var b="";b.length<a.value.length;)b+="*";c.value=
b;break;default:c.value=a.value}break;case "SELECT":c.options={};for(b=a.options.length-1;0<=b;b--)a.options[b].selected&&(c.options[b]=a.options[b].selected);break;case "TEXTAREA":c.value=a.value}k("agentInputChange",c)};q.startBrowsingAgent=function(a,c){f=a;u=c;l=!0;KandyAPI.Session.setListeners(f,{onData:Q});k("requestFullPage",!0)};q.stopBrowsingAgent=function(){E();for(v=p=e=g=null;u.firstChild;)u.removeChild(u.firstChild);f=u=null;l=!1};var J=function(a){k("userMousePosition",{x:a.clientX,
y:a.clientY})},K=function(a){n&&k("userWindowScroll",{x:0!=a.target.documentElement.scrollLeft?a.target.documentElement.scrollLeft:a.target.body.scrollLeft,y:0!=a.target.documentElement.scrollTop?a.target.documentElement.scrollTop:a.target.body.scrollTop});n=!0},L=function(a){k("userWindowResize",{x:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,y:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight})},z=function(a,c){var b="string"==
typeof a?a:"HTML",d;"HTML"==b?(d=C(document.doctype)+document.documentElement.outerHTML,d=C(w(d))):"HEAD"==b?d=w(document.head.outerHTML).head.outerHTML:"BODY"==b?d=w(document.body.outerHTML).body.outerHTML:(d=b.substr(1),d=w(document.getElementById(d).outerHTML).getElementById(d).outerHTML);d={element:b,html:d};for(var m="",f=document.getElementsByTagName("style"),e=0;e<f.length;e++)m+=f[e].innerHTML;if(m!==D||"HTML"==b)d.css=D=m,console.log("New CSS");"HTML"==b&&(d.screenx=window.innerWidth||document.documentElement.clientWidth||
document.body.clientWidth,d.screeny=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,d.scrollx=0!=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft,d.scrolly=0!=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop);if("HTML"==b||"HEAD"==b)d.baseURI=document.baseURI;k("screenUpdate",d,c);console.log(Math.floor(Date.now()/1E3)+" Screen Sent "+b)},N=function(){document.removeEventListener("mousemove",
J);document.removeEventListener("scroll",K);window.removeEventListener("resize",L);window.removeEventListener("input",x);window.removeEventListener("change",M)};mutationHandler=function(a,c){a.forEach(function(a){var c=0,b="",d=[];if("undefined"==typeof a.addedNodes[0]||a.addedNodes[0].id!="coBrowsingCursor-"+f){for(a="characterData"==a.type||"attributes"==a.type&&"id"==a.attributeName?a.target.parentNode:a.target;a.parentNode;){if(""!=a.id||"HTML"==a.tagName||"HEAD"==a.tagName||"BODY"==a.tagName)thisID=
"HTML"==a.tagName||"HEAD"==a.tagName||"BODY"==a.tagName?a.tagName:"#"+a.id,""==b&&(b=thisID),d.push(thisID);""!=b&&c++;a=a.parentNode}if(""==b)return h="HTML",!1;if(b=="#coBrowsingCursor-"+f)return!1;d=d.reverse();if(-1==r)console.log("First element: "+b+" ("+c+")"),r=c,h=b,t=d;else if(-1==d.indexOf(h)){console.log(b+" ("+c+") not under "+h);var e="HTML";t.forEach(function(a){if(-1!=d.indexOf(a))e=a;else return!1});r=t.indexOf(e)+1;h=e;t=t.slice(0,r);console.log("Renegotiated top to: "+h+" ("+r+")")}}});
var b=O(),d=x();0!=b||0!=d?console.log("Updated skipped, ids:"+b+" forms:"+d):("HTML"==h?(console.log("Doing a full page refresh"),z()):""!=h&&(console.log("Doing a partial page update on: "+h),z(h)),r=-1,t=h="")};q.startBrowsingUser=function(a){f=a;l=!0;KandyAPI.Session.setListeners(f,{onData:R});O();x();z();N();document.addEventListener("mousemove",J);document.addEventListener("scroll",K);window.addEventListener("resize",L);window.addEventListener("input",x);window.addEventListener("change",M);
B=new MutationObserver(mutationHandler);B.observe(document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0})};q.stopBrowsingUser=function(){B.disconnect();N();k("closeCoBrowse",!0);var a=document.getElementById("coBrowsingCursor-"+f);null!=a&&a.remove();l=!1};var w=function(a){var c=["SCRIPT","STYLE"],b=/^on/i,d=/^javascript:/i,m=[];a=(new DOMParser).parseFromString(a,"text/html");for(var e=a.getElementsByTagName("*"),g=0;g<e.length;g++){var h=e[g];if(-1!=c.indexOf(h.nodeName))m.push(h);
else for(var k=0;k<h.attributes.length;k++){var l=h.attributes[k];b.test(l.name)?h.removeAttribute(l.name):d.test(l.value)&&(l.value="")}}for(c=document.createTreeWalker(a,NodeFilter.SHOW_COMMENT,null,!1);c.nextNode();)m.push(c.currentNode);m.forEach(function(a){a.parentNode.removeChild(a)});(m=a.getElementById("coBrowsingCursor-"+f))&&m.parentNode&&m.parentNode.removeChild(m);return a},C=function(a){if("object"===typeof a&&null!=a){if("undefined"!=typeof window.XMLSerializer)return(new window.XMLSerializer).serializeToString(a);
if("undefined"!=typeof a.xml)return a.xml}return""},x=function(){if(A){for(var a=0,c=document.getElementsByTagName("input"),b=0;b<c.length;b++){var d=c[b];switch(d.type){case "password":for(var e="";e.length<d.value.length;)e+="*";d.defaultValue!=e&&(d.defaultValue=e,a++);break;case "checkbox":case "radio":d.defaultChecked!=d.checked&&(d.defaultChecked=d.checked,a++);break;case "reset":case "submit":case "button":break;default:d.defaultValue!=d.value&&(d.defaultValue=d.value,a++)}}c=document.getElementsByTagName("select");
for(b=0;b<c.length;b++)for(d=c[b],e=d.options.length-1;0<=e;e--)d.options[e].defaultSelected!=d.options[e].selected&&(d.options[e].defaultSelected=d.options[e].selected,a++);d=document.getElementsByTagName("textarea");for(b=0;b<d.length;b++)d[b].defaultValue!=d[b].value&&(d[b].defaultValue=d[b].value,a++);return a}A=!0},M=function(a){"INPUT"!=a.target.nodeName||"radio"!=a.target.type&&"checkbox"!=a.target.type||x()},O=function(){for(var a=0,c=document.querySelectorAll('body *:not([id]), body *[id=""]'),
b=0;b<c.length;b++){for(;null!=document.getElementById("uid-ui-"+a);)a++;c[b].id="uid-ui-"+a;a++}return c.length};return q}();